<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f3f3f3;
            color: #333;
        }
        h1 {
            text-align: center;
            margin-top: 20px;
        }
        #map {
            height: 600px; /* Adjust height as needed */
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content-wrapper {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .leaflet-popup-content {
            margin: 10px;
        }
        .leaflet-popup-close-button {
            display: none;
        }
    </style>
    <link rel="icon" href="data:,"> <!-- Disable favicon request -->
</head>
<body>
    <h1>Current Location</h1>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        function initMap() {
            // Get the current position of the user
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLatitude = position.coords.latitude;
                var userLongitude = position.coords.longitude;

                // Create a map centered at the user's location with a lower zoom level
                var map = L.map('map').setView([userLatitude, userLongitude], 8); // Adjust the zoom level here

                // Add OpenStreetMap tiles to the map
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Create a marker for the user's location
                var userMarker = L.marker([userLatitude, userLongitude]).addTo(map);
                userMarker.bindPopup("<b>Your Location</b>").openPopup();

                // Fetch the JSON data from serial_data.json
                setInterval(function() {
                    fetch('./serial_data.json')
                        .then(response => response.json())
                        .then(data => {
                            // Filter out latitude and longitude properties from the JSON data
                            var latitudeData = data.latitude.filter(lat => !isNaN(parseFloat(lat)));
                            var longitudeData = data.longitude.filter(lon => !isNaN(parseFloat(lon)));

                            // Get the last latitude and longitude values
                            var lastLatitude = parseFloat(latitudeData[latitudeData.length - 1]);
                            var lastLongitude = parseFloat(longitudeData[longitudeData.length - 1]);

                            // Check if latitude and longitude are valid numbers
                            if (!isNaN(lastLatitude) && !isNaN(lastLongitude)) {
                                // Define a custom red marker icon
                                var redIcon = L.icon({
                                    iconUrl: 'marker-icon-red.png', // Local path to the red marker icon image
                                    iconSize: [41, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34],
                                    tooltipAnchor: [16, -28],
                                    shadowSize: [41, 41]
                                });

                                // Remove previous satellite marker
                                if (typeof satelliteMarker !== 'undefined') {
                                    map.removeLayer(satelliteMarker);
                                }

                                // Create a marker with the custom red icon for the new location
                                var satelliteMarker = L.marker([lastLatitude, lastLongitude], { icon: redIcon }).addTo(map);
                                satelliteMarker.bindPopup("<b>Satellite Position</b>").openPopup();

                                // Adjust map bounds to include both user and satellite locations
                                var bounds = L.latLngBounds([
                                    [userLatitude, userLongitude],
                                    [lastLatitude, lastLongitude]
                                ]);
                                map.fitBounds(bounds);
                            } else {
                                console.error('Invalid latitude or longitude values:', data);
                            }
                        })
                        .catch(error => console.error('Error fetching data:', error));
                }, 10000); // Adjust the refresh time here (in milliseconds)
            }, function (error) {
                // Handle any errors in obtaining the user's location
                console.error('Error getting user location:', error);
            });
        }
        window.onload = initMap;
    </script>
</body>
</html>
